const kh_global=Function("return globalThis;")()||Function("return this;")()||Function("return self;")();const as_module=undefined==this;const asWorker="undefined"===typeof window&&"undefined"===typeof process&&self;const cf="kh_vanilla";const mf="kh_vanilla2_esm";kh_global.kh??={};kh_global.kh.context??="undefined"!==typeof window?kh_global.parent==kh_global?"window":"iframe":"undefined"!==typeof process?"node.js":"undefined"!==typeof self?self.name??"worker":"unknown";kh_global.kh.storage??={};const cs=kh_global.kh.storage[cf]??={cf,ms:new Set};const ms=kh_global.kh.storage[mf]??={mf,cs};cs.ms.add(ms);import*as kh_js_e from"/contrib/jsm/kh_earlybird.js";import*as kh_js_c from"/contrib/jsm/kh_classes.js";import*as kh_js_f from"/contrib/jsm/kh_functions.js";const kh_js=Object.assign({...kh_js_e},{...kh_js_c},{...kh_js_f});import{vjs}from"/contrib/jsm/kh_vanilla.js";const name=MF`${mf}`;const print_level=undefined;import{Logger}from"/contrib/jsm/kh_log.js";const kh_log=new Logger(print_level,(()=>name));cs.strings??=function(){const vjs_sm=new kh_js.StringMap({"vjs-switch-flag":"data-kh-switch","style.status.text":"","id.app.status":"app-status"});kh_js.StringMap.getGlobalMap().addEntries(vjs_sm);return vjs_sm}();function handle_css_switch_on(force=false){if(force||!kh_js.isValid(cs["css-switch-on-value"])){const def_switch_on=800;let switch_on=Number.parseInt(vjs.cssvar(vjs.body,"--orient-switch"))||def_switch_on;if(def_switch_on!=switch_on){function replace_switch_on(new_switch_on,old_switch_on){let new_switch_on_px=`${new_switch_on}px`;const old_switch_on_px=`${old_switch_on}px`;const no_replace=".kh-no-replace";[...document.styleSheets].forEach((ss=>{try{[...ss.cssRules||[]].filter((rule=>kh_js.isValid(rule.media)&&-1!=rule.media.mediaText.indexOf(old_switch_on_px)&&-1==[...rule.cssRules||[]].findIndex((css_rule=>-1!=css_rule.selectorText.indexOf(no_replace))))).forEach((rule=>{rule.media.mediaText=rule.media.mediaText.replace(old_switch_on_px,`${new_switch_on_px}`)}))}catch(error){kh_log.trace?.(`can't access CSS from ${ss.href} => ${error}`)}}))}replace_switch_on(switch_on,def_switch_on);replace_switch_on(switch_on+1,def_switch_on+1)}cs["css-switch-on-value"]=switch_on}return cs["css-switch-on-value"]}const C={get orient_switch_handler(){return cs["orient-switch-handler"]},set orient_switch_handler(value){cs["orient-switch-handler"]=value},get orient_switch_width(){return cs["orient-switch-handler-width"]},set orient_switch_width(value){cs["orient-switch-handler-width"]=value}};export function install_resize_handler(){if(!kh_js.isValid(C.orient_switch_handler)){const switch_on=handle_css_switch_on();C.orient_switch_handler=(event,fake)=>{if(!C.orient_switch_width||C.orient_switch_width<=switch_on^kh_global.innerWidth<=switch_on){const switch_flag=kh_global.kh.storage.kh_js.unzipString("vjs-switch-flag");const switch_value=kh_global.innerWidth<=switch_on?"vertical":"horizontal";vjs.html.setAttribute(switch_flag,switch_value);if(!fake)vjs.trigger(switch_flag,window,{switch_value})}C.orient_switch_width=kh_global.innerWidth};const vhw_setter=t_u=>{const vh=Math.min(window.innerHeight,window.outerHeight)*.01;const vw=Math.min(window.innerWidth,window.outerWidth)*.01;vjs.cssvar(vjs.html,"--vh",`${vh}px`);vjs.cssvar(vjs.html,"--vw",`${vw}px`);t_u.ticker=false};const vhs_ticker={ticker:false,updater:vhw_setter};vjs.on("resize",(event=>{C.orient_switch_handler(event,false);kh_js.requestTick(vhs_ticker)}),window);C.orient_switch_handler(null,true);vhw_setter(vhs_ticker)}}export function install_resize_handler_v2(){if(true!==CSS.supports("width:100dvw"))return install_resize_handler();if(!kh_js.isValid(C.orient_switch_handler)){C.orient_switch_handler=function(event,fake=false){const switch_flag=kh_global.kh.storage.kh_js.unzipString("vjs-switch-flag");const switch_value=event.matches?"vertical":"horizontal";vjs.html.setAttribute(switch_flag,switch_value);if(!fake)vjs.trigger(switch_flag,window,{switch_value})};const switch_on=handle_css_switch_on();const mql=window.matchMedia(`(max-width:${switch_on}px)`);mql.addEventListener("change",C.orient_switch_handler);C.orient_switch_handler({matches:kh_global.innerWidth<=switch_on},true)}}export async function onReadyStd(app_context,{string_tables=[],app_lang,force_secure=true,irh_flag=true,logger=kh_log}={}){if(false!==force_secure&&"https:"!==kh_global.location.protocol){kh_global.location.replace(`https:${kh_global.location.href.substring(location.protocol.length)}`)}if(kh_js.isValid(app_context)){app_context.subRoute??=(()=>{const pn=window.location.pathname;return 1<pn.length&&pn.endsWith("/")?pn.substring(0,pn.length-1):pn})();app_context.setStatus??=function(text,cat="err",delay_clear=1e4){let Șstatus=vjs(`#${app_context.unzip?.("id.app.status")??"status.bar"}`);if(kh_js.isEmpty(Șstatus))return;if(Array.isArray(Șstatus))Șstatus=Șstatus[0];text||="???";if(Array.isArray(text))Șstatus.append(...text);else if(kh_js.isDOMElement(text))Șstatus.append(text);else Șstatus.innerContent=T9`${text}`;logger["err"==cat?"error":"wrn"==cat?"warn":"info"]?.(T9`status: ${text}`);Șstatus.setAttribute("class",(app_context.unzip?.("class.app.status.stem")??"")+cat);if(-1!=delay_clear)kh_global.setTimeout((()=>{vjs.empty(Șstatus);Șstatus.setAttribute("class","")}),delay_clear)}}string_tables.forEach((string_table=>kh_js.StringMap.getGlobalMap().addEntries(string_table)));let browser_lang=kh_js.getBrowserLang({query:"html",attribute:"lang"});kh_log.assert?.(browser_lang==kh_js.getAttribute2("html","lang",undefined,undefined,"attr").lang,"must-be-equal","getLanguage() results");if(kh_js.isValid(app_lang))kh_js.setBrowserLang({query:"html",attribute:"lang",lang:app_lang});kh_js.StringMap.getGlobalMap().afterLocale();vjs.html.setAttribute("data-mobile",kh_js.isMobile()?"1":"0");vjs.html.setAttribute("data-touch",kh_js.isTouch()?"1":"0");vjs.html.setAttribute("data-browser",kh_js.getBrowserShort());vjs.html.setAttribute("data-os",kh_js.getOSShort());vjs.html.setAttribute("data-pdfve",kh_js.pdfViewerEnabled()?"1":"0");if(false!=irh_flag)install_resize_handler_v2()}export function NodeFromTemplate(template_name,as_string=false){try{if(kh_js.isEmpty(template_name)){const p=document.createElement("p");p.textContent=`template name - ${kh_global.kh.storage.kh_js.unzipString("param-not-determined")}`;return!as_string?p:p.outerHTML}try{let Ștemplate=vjs(`${template_name.startsWith("#")?"":"#"}${template_name}`,false);if(kh_js.isValid(Ștemplate))return!as_string?[...Ștemplate.content.children].map((c=>c.cloneNode(true))):Ștemplate.innerHTML;else{const p=document.createElement("p");p.textContent=`template - ${template_name} - ${kh_global.kh.storage.kh_js.unzipString("invalid-argument")}`;return!as_string?[p]:p.outerHTML}}catch(error){debugger}}finally{kh_js.yieldToMain().then((()=>handle_css_switch_on(true)))}}export class Elements{static fromPhone(phones,sep="-",nnbsp=" "){if(kh_js.isEmpty(phones))return undefined;if(!Array.isArray(phones))phones=[phones];const parentNode=1<phones.length?document.createElement("div"):undefined;if(kh_js.isValid(parentNode)){parentNode.classList.add("kh-vlayout");vjs.cssvar(parentNode,"--gap-v",0)}const phone_nodes=phones.map((phone=>{const div=vjs.create("div",{class:{"kh-hlayout":true,"kh-not-grow":true}});const p=vjs.create("p",{text:`☎`},div);const a=vjs.create("a",{href:`tel:${phone.split(sep).join("")}`,text:phone.split(sep).join(nnbsp),dataType:"phone"},div);return div}));if(kh_js.isValid(parentNode)){phone_nodes.forEach((pn=>parentNode.insertAdjacentElement("beforeend",pn)));return parentNode}else return phone_nodes[0]}static fromMailAddress(mailaddresses,crypt_shift,nnbsp=" "){if(kh_js.isEmpty(mailaddresses))return undefined;if(!Array.isArray(mailaddresses))mailaddresses=[mailaddresses];const parentNode=1<mailaddresses.length?document.createElement("div"):undefined;if(kh_js.isValid(parentNode)){parentNode.classList.add("kh-vlayout");vjs.cssvar(parentNode,"--gap-v",0)}const mailaddress_nodes=mailaddresses.map((mailaddress=>{const div=vjs.create("div",{class:{"kh-hlayout":true,"kh-not-grow":true}});const p=vjs.create("p",{text:`✉`},div);let visible_mailaddress=mailaddress;try{let mail_url=mailaddress;if(!(mail_url instanceof URL)){if(!mail_url.startsWith("mailto:"))mail_url=`mailto:${mail_url}`;mail_url=new URL(mail_url)}visible_mailaddress=`${mail_url.pathname}`;mailaddress=mail_url}catch(error){kh_log.warn(T9`${new kh_js.Error({msg:["param-invalid","mail-address",mailaddress],cause:error})}`)}const a=vjs.create("a",{href:kh_js.CryptMailto(mailaddress,crypt_shift),text:visible_mailaddress.split("").join(nnbsp),dataType:"mail"},div);return div}));if(kh_js.isValid(parentNode)){mailaddress_nodes.forEach((pn=>parentNode.insertAdjacentElement("beforeend",pn)));return parentNode}else return mailaddress_nodes[0]}}export function MousePos2Client(event,element=event.target){const rect=element.getBoundingClientRect();const mp=vjs.MousePos(event);return{x:mp.x-rect.left,y:mp.y-rect.top}}export function collectFromAttribute(id_base,attribute,id,event){const wgt_base=kh_js.getDOMObjectsFromStr(id_base);const elems=!kh_js.isEmpty(attribute)?vjs(wgt_base,`[${attribute}]`,true):undefined;const ids=vjs.attr(elems,"id")??[];let receiver=id||wgt_base||vjs(`#'div.kh-window-main`)||kh_global.zk&&jq("@window");if(!kh_global.zk)vjs.trigger(event||"onCollectFromAttribute",receiver,ret);else kh_js.sendEvent?.(vjs.attr(receiver[0]??receiver,"id"),event||"onCollectFromAttribute",ret?JSON.stringify(ret):ret)}export function getHtml4Download(selector,filename){const elements=vjs(selector);if(kh_js.isEmpty(elements))return;const content=elements.map((elem=>elem.textContent)).join("\n");return kh_js.downloadContent2File({content,filename})}export function createHtmlTable({table_opt,header=true,body=true,footer=true,parent}={}){const table=vjs.create("table",table_opt,parent);function createStructure(name,opt,with_row=true,parent=table){const structure_element=vjs.create(name,kh_js.isPlainObject(opt)?opt:undefined,parent);if(with_row){vjs.create("td",undefined,vjs.create("tr",undefined,structure_element))}return structure_element}if(true==header||kh_js.isPlainObject(header))createStructure("thead",header,true);if(true==body||kh_js.isPlainObject(body))createStructure("tbody",body,true);if(true==footer||kh_js.isPlainObject(footer))createStructure("tfoot",footer,true);return table}export function startViewTransition(callback,value){if(!kh_js.isValid(document.startViewTransition)){const updateCallbackDone=new Promise(((resolve,reject)=>{try{const result=callback(value);if(result instanceof Promise)result.then((r=>resolve(r))).catch((error=>reject(error)));else resolve(result)}catch(error){reject(error)}}));return{ready:Promise.resolve(true),updateCallbackDone,finished:updateCallbackDone.then((()=>true)),skipTransition(){return Promise.reject(new kh_js.Error({msg:["invalid-operation","skipTransition"]}))}}}else{return document.startViewTransition((async()=>{try{const result=await callback(value)}catch(error){kh_log.error?.(T9`error in startViewTransition callback / ${kh_js.currentFunctionName()} / => ${error}`);throw error}}))}}export function getTextEntent({text,fontFamily,fontSize="1em"}={}){const canvas=vjs.create("canvas");const ctxt=canvas.getContext("2d");ctxt.font=`${fontSize} ${fontFamily}`;return ctxt.measureText(text)}Object.assign(cs,{collectFromAttribute});kh_global.LoadedScripts?.get(mf).resolve(ms);