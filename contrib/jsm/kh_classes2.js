const kh_global=Function("return globalThis;")()||Function("return this;")()||Function("return self;")();const as_module=undefined==this;const asWorker="undefined"===typeof window&&"undefined"===typeof process&&self;const cf="kh_js";const mf="kh_classes2_esm";kh_global.kh??={};kh_global.kh.context??="undefined"!==typeof window?kh_global.parent==kh_global?"window":"iframe":"undefined"!==typeof process?"node.js":"undefined"!==typeof self?self.name??"worker":"unknown";kh_global.kh.storage??={};const cs=kh_global.kh.storage[cf]??={cf,ms:new Set};const ms=kh_global.kh.storage[mf]??={mf,cs};cs.ms.add(ms);import*as kh_js_e from"/contrib/jsm/kh_earlybird.js";import*as kh_js_c from"/contrib/jsm/kh_classes.js";const kh_js=Object.assign({...kh_js_e},{...kh_js_c});const name=MF`${mf}`;const print_level=undefined;import{Logger}from"/contrib/jsm/kh_log.js";const kh_log=new Logger(print_level,(()=>name));export class Map2Array extends Map{constructor(unique=false){super();this["#unique_"]=true===unique||"equals"==unique||"function"===typeof unique;this["compare_"]="equals"==unique?(v1,v2)=>v1?.equals(v2):"function"===typeof unique?unique:undefined}get[Symbol.toStringTag](){return Map2Array.prototype.constructor.name}set(key,value){if(kh_js.isValid(value)&&!Array.isArray(value))throw new kh_js.Error({msg:["invalid-argument","value",value]});return super.set(key,value)}add(key,values){if(!kh_js.isValid(key)||kh_js.isEmpty(values))return;if(!Array.isArray(values))values=[values];let values_arr=this.get(key);if(!kh_js.isValid(values_arr))this.set(key,values_arr=[]);values=values.filter((value=>!this["#unique_"]||-1==(kh_js.isValid(this["compare_"])?values_arr.findIndex(this["compare_"].bind(null,value)):values_arr.indexOf(value))));values_arr.push(...values);return values}remove(key,values,remove_all=true){if(!kh_js.isValid(key)||kh_js.isEmpty(values))return;if(!Array.isArray(values))values=[values];let values_arr=this.get(key);if(!kh_js.isValid(values_arr))this.set(key,values_arr=[]);values=values.filter((value=>{let ret=undefined;let from_index=0;while(true){const idx=kh_js.isValid(this["compare_"])?values_arr.findIndex(this["compare_"].bind(null,value)):values_arr.indexOf(value,from_index);if(-1==idx)return ret;else{if(undefined==ret)ret=value;values_arr.splice(idx,1);if(this["#unique_"]||!remove_all)return ret;from_index=idx}}}));return values}has(key,values){if(kh_js.isEmpty(values))return super.has(key);else{const val=super.get(key);if(!Array.isArray(values))values=[values];return val?.includes(values)}}}export class FIFO{#a_=[];#b_=[];constructor(...vals){this.push(...vals??[])}get length(){return this.#a_.length+this.#b_.length}push(...vals){if(kh_js.isEmpty(vals))return;this.#a_.push(...vals)}pop(){this.#moveToPop();return this.#b_.pop()}peek(){this.#moveToPop();return this.#b_[this.#b_.length-1]}last(){this.#moveToPop();return this.#b_[0]}toArray(){this.#moveToPop();return[...this.#b_.toReversed(),...this.#a_]}at(idx,val){idx=Math.trunc(idx)||0;if(0>idx)idx+=this.length;if(0>idx||this.length<=idx)throw new Error("IndexOutOfBounds");if(undefined==val){if(this.#b_.length>idx)return this.#b_[this.#b_.length-idx-1];else return this.#a_[idx-this.#b_.length]}else{if(this.#b_.length>idx)this.#b_[this.#b_.length-idx-1]=val;else this.#a_[idx-this.#b_.length]=val}}#moveToPop(){if(0===this.#b_.length){while(0<this.#a_.length){this.#b_.push(this.#a_.pop())}}}}export class LIFO{#c_=[];constructor(...vals){this.push(...vals??[])}get length(){return this.#c_.length}push(...vals){if(kh_js.isEmpty(vals))return;this.#c_.push(...vals)}pop(){return this.#c_.pop()}peek(){return this.#c_[this.length-1]}last(){return this.#c_[0]}toArray(){return this.#c_}at(idx,val){idx=Math.trunc(idx)||0;if(0>idx)idx+=this.length;if(undefined==val)return this.#c_.at(this.length-1-idx);else{if(0>idx||this.length<=idx)throw new Error("IndexOutOfBounds");this.#c_[this.length-1-idx]=val}}}export class SetWithAutoRemove extends Set{#remove_after_;constructor(remove_after=1e3){super();this.#remove_after_=remove_after}add(id,remove_after=this.#remove_after_){this.delete(id,true);const tid=kh_global.setTimeout((()=>this.delete(id)),remove_after);return super.add({id,tid})}has(key){if(!kh_js.isString(key))return super.has(key);else{return-1!==[...this.values()].findIndex((value=>key==value.id))}}delete(key,clearTimeout=false){if(kh_js.isString(key)){key=[...this.values()].find((value=>key==value.id))}if(kh_js.isPlainObject(key)){if(clearTimeout)kh_global.clearTimeout(key.tid);return super.delete(key)}return false}}export function arrayView(array,must_equal_length=true){if(kh_js.isEmpty(array))return array;const m=array.length;const n=array[0].length;for(let i=1;i<m;++i){if(array[i].length!==n){if(!must_equal_length)return arrayViewExt(array);throw new kh_js.Error({msg:["wrong-usage-of","arrayView"]})}}let revoked=false;const proxy=new Proxy(array,{get(target,prop,receiver){if(revoked)throw new kh_js.Error("invalid-operation");if(kh_js.isSymbol(prop)){if(prop==Symbol.iterator){let ci=0;return{next:()=>{const done=ci>=receiver.length;return{value:!done?receiver[ci++]:undefined,done}}}}return undefined}if("length"==prop)return m*n;else if("release"==prop){return function(){const ret=array;array=undefined;revoked=true;return ret}}else if(kh_js.isNumber(prop,true)){const _m=prop/n|0;if(m<=_m)throw new RangeError(T9`index must 0..${m*n-1}`);const _n=prop%n|0;return array[_m][_n]}else if(prop in Array.prototype){const retf=Array.prototype[prop].bind(receiver);switch(prop){case"push":throw new kh_js.Error("invalid-operation");case"map":{return function(...argz){const new_arr=array.map((inner_array=>inner_array.map(...argz)));return arrayView(new_arr)}}default:return retf}}else return Reflect.get(target,prop)},has(target,prop){if(+prop<m*n||"length"==prop)return true;return Reflect.has(target,prop)},ownKeys(){return["length",...[...new Array(m*n)].map(((v,i)=>`${i}`))]},getOwnPropertyDescriptor(target,key){return{enumerable:true,configurable:true,value:this.get(target,key,this)}}});return proxy}export function arrayViewExt(array){if(kh_js.isEmpty(array))return array;const m=array.length;const n=[array[0].length];for(let i=1;i<m;++i){n.push(n[i-1]+array[i].length)}let length=n.reduce(((pv,cv)=>pv+cv),0);let revoked=false;const proxy=new Proxy(array,{get(target,prop,receiver){if(revoked)throw new kh_js.Error("invalid-operation");if(kh_js.isSymbol(prop)){if(prop==Symbol.iterator){let ci=0;return{next:()=>{const done=ci>=receiver.length;return{value:!done?receiver[ci++]:undefined,done}}}}return undefined}if("length"==prop)return length;else if("release"==prop){return function(){const ret=array;array=undefined;revoked=true;return ret}}else if(kh_js.isNumber(prop,true)){let _m,_n;for(let i=0;i<m;++i){prop-n[i];if(0>prop){_m=i+1;n=n[_m]+prop;break}}if(0<=prop)throw new RangeError(T9`index must 0..${length-1}`);return array[_m][_n]}else if(prop in Array.prototype){const retf=Array.prototype[prop].bind(receiver);switch(prop){case"push":throw new kh_js.Error("invalid-operation");case"map":{return function(...argz){const new_arr=array.map((inner_array=>inner_array.map(...argz)));return arrayView(new_arr)}}default:return retf}}else return Reflect.get(target,prop)},has(target,prop){if(+prop<m*n||"length"==prop)return true;return Reflect.has(target,prop)},ownKeys(){return["length",...[...new Array(m*n)].map(((v,i)=>`${i}`))]},getOwnPropertyDescriptor(target,key){return{enumerable:true,configurable:true,value:this.get(target,key,this)}}});return proxy}kh_global.LoadedScripts.get(mf).resolve(ms);