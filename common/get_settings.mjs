const kh_global=Function("return globalThis;")()||Function("return this;")()||Function("return self;")();const as_module=undefined==this;const asWorker="undefined"===typeof window&&"undefined"===typeof process&&self;const cf="kh_server";const mf="common_get_settings_esm";kh_global.kh??={};kh_global.kh.context??="undefined"!==typeof window?kh_global.parent==kh_global?"window":"iframe":"undefined"!==typeof process?"node.js":"undefined"!==typeof self?self.name??"worker":"unknown";kh_global.kh.storage??={};const cs=kh_global.kh.storage[cf]??={cf,ms:new Set};const ms=kh_global.kh.storage[mf]??={mf,cs};cs.ms.add(ms);import*as kh_js_e from"/contrib/jsm/kh_earlybird.js";import*as kh_js_c from"/contrib/jsm/kh_classes.js";import*as kh_js_f from"/contrib/jsm/kh_functions.js";const kh_js=Object.assign({...kh_js_e},{...kh_js_c},{...kh_js_f});const name=MF`${mf}`;const print_level=undefined;import{Logger}from"/contrib/jsm/kh_log.js";const kh_log=new Logger(print_level,(()=>name));import{SROptionsMap}from"/common/sr_options.mjs";export class SettingsFilter extends SROptionsMap{static#as_="app-settings";static#ss_="server-settings";static#as_rex_=new RegExp(`^[/]?${SettingsFilter.#as_}(?:/([^/]+))?[/]?$`);constructor(){super()}tf(sub_route,func){const as_match=SettingsFilter.#as_rex_.exec(sub_route);if(!kh_js.isEmpty(as_match?.[1])){sub_route=SettingsFilter.#as_;func={sr:as_match[1],f:func}}else sub_route=this.t(sub_route);return{sub_route,func:func??{}}}add(sub_route,func){({sub_route,func}=this.tf(sub_route,func));let funcs=this.get(sub_route);funcs||this.set(sub_route,funcs=[]);funcs.push(func)}remove(sub_route,func){({sub_route,func}=this.tf(sub_route,func));let funcs=this.get(sub_route);if(kh_js.isEmpty(funcs))return;const idx=funcs.findIndex((f=>(f.f??f)==func));if(-1!=idx)funcs.splice(idx,1)}process(sub_route,settings={},req){let func;({sub_route,func}=this.tf(sub_route,undefined));let funcs=this.get(sub_route);if(kh_js.isEmpty(funcs))return settings;if(SettingsFilter.#as_==sub_route){settings=funcs.reduce(((cur_settings,f)=>(kh_js.isEmpty(func.sr)||kh_js.isEmpty(f.sr)||f.sr==func.sr)&&(f.f??f)(cur_settings,req)||cur_settings),settings)}else{settings=funcs.reduce(((cur_settings,f)=>f(cur_settings,req)),settings);if(SettingsFilter.#ss_==sub_route)settings=this.process(SettingsFilter.#as_,settings,req)}return settings}}export const SettingsFilterFunc=new SettingsFilter;export async function MakeGetSettingsRouter(server_context=cs,sub_route,add_config={}){const Router=(await import("/common/router_sub_route.mjs")).Router;const router=new Router(undefined,sub_route,add_config.router_opt);const filter=function(server_settings){delete server_settings.key;delete server_settings.cert;delete server_settings.key_file;delete server_settings.cert_file;delete server_settings.passw;delete server_settings.passphrase;delete server_settings.session_secret;delete server_settings.wss?.clientTracking;server_settings=kh_js.minify_json(server_settings,{filter_key:"comment",as_string:false});return server_settings};SettingsFilterFunc.add("/server-settings",filter);router.get("/server-settings",((req,res,next)=>{kh_log.debug?.(`router:${server_context.get_method2(req)}) -> request= ${req.originalUrl}, sessionID= ${server_context.sessionID(req)}`);let settings=JSON.parse(JSON.stringify(server_context.server_options||{}));settings=SettingsFilterFunc.process(req.path,settings,req);res.json(settings)})).get("{/:sub_route}/app-settings",((req,res,next)=>{kh_log.debug?.(`router:${server_context.get_method2(req)}) -> request= ${req.originalUrl}, sessionID= ${server_context.sessionID(req)}`);const sub_route=req.params.sub_route;let settings=JSON.parse(JSON.stringify(server_context.server_options||{}));settings=SettingsFilterFunc.process(`/app-settings/${sub_route??""}`,settings,req);settings=kh_js.minify_json(settings,{filter_key:"comment",as_string:false});settings=(kh_js.isEmpty(req.params.sub_route)?settings.app_settings:settings.sr?.[sub_route])||{};res.json(settings)}));return router}kh_global.LoadedScripts.get(mf).resolve(ms);