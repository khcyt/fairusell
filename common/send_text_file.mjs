const kh_global=Function("return globalThis;")()||Function("return this;")()||Function("return self;")();const as_module=undefined==this;const asWorker="undefined"===typeof window&&"undefined"===typeof process&&self;const cf="kh_server";const mf="common_send_text_file_esm";kh_global.kh??={};kh_global.kh.context??="undefined"!==typeof window?kh_global.parent==kh_global?"window":"iframe":"undefined"!==typeof process?"node.js":"undefined"!==typeof self?self.name??"worker":"unknown";kh_global.kh.storage??={};const cs=kh_global.kh.storage[cf]??={cf,ms:new Set};const ms=kh_global.kh.storage[mf]??={mf,cs};cs.ms.add(ms);let jsm_prefix;if("undefined"!==typeof process){jsm_prefix=`file:///${kh_global.kh.pathes.get("own-module")}`}else{jsm_prefix=`/contrib/jsm`;console.assert(0,`${mf} is only for node.js`)}let kh_js={};Object.assign(kh_js,await import(`${jsm_prefix}/kh_earlybird${VERSION}.js`));Object.assign(kh_js,await import(`${jsm_prefix}/kh_classes${VERSION}.js`));Object.assign(kh_js,await import(`${jsm_prefix}/kh_functions${VERSION}.js`));let print_level=undefined;const{Logger}=await import(`${jsm_prefix}/kh_log${VERSION}.js`);const kh_log=new Logger(print_level,(()=>MF`${mf}`));async function release_info(){if(!kh_js.isValid(ms.release_info)){const{getReleaseVersion,getPackageData}=await import(`./get_release_version${VERSION}.mjs`);const release_version=getReleaseVersion();let rv_parts=release_version.split(".");if(rv_parts[0]<2020){rv_parts.rotate(1);[rv_parts[1],rv_parts[2]]=rv_parts[1].split("+")}const release_date=new Date(new Date(rv_parts.join("-")).getTime()+12*60*60*1e3);const package_data=getPackageData();ms.release_info={release_version,release_date,package_data}}return ms.release_info}import{Buffer}from"node:buffer";import*as path from"node:path";import*as fs from"node:fs";import mime from"mime";const mime_extension=(mime.getExtension||mime.extension).bind(mime);const mime_getType=(mime.getType||mime.lookup).bind(mime);function must_send_direct(content_type){switch(content_type){case mime_getType("pdf"):case mime_getType("svg"):return true;default:{if(content_type.startsWith("font/"))return true;if(content_type.startsWith("image"))return true}}return false}export async function sendTextFile(base_name,req,res,app){return new Promise(((resolve,reject)=>{if(kh_js.isEmpty(base_name))return reject(new kh_js.Error("invalid-argument","base_name"));if(!kh_js.isValid(res))return reject(new kh_js.Error("invalid-argument","res"));const resolved_file=path.resolve(base_name);if(kh_js.isEmpty(resolved_file))return reject(new kh_js.Error("param-not-determined",`resolve(${base_name})`));return resolve(resolved_file)})).then((async resolved_file=>{let last_point=req.path.lastIndexOf(".");const suffix=-1!=last_point?req.path.substring(last_point+1):"html";const content_type=mime_getType(suffix)??"text/html";if(must_send_direct(content_type)){const stats=fs.statSync(resolved_file);return res.sendFile(resolved_file,{headers:kh_js.removeEmpty({"Last-Modified":stats?.mtime.toUTCString(),"Content-Length":stats?.size})})}else{const appName=req?.sub_route??app?.locals?.title??"kh-webapp";return Promise.all([fs.promises.readFile(resolved_file,"utf-8"),fs.promises.stat(resolved_file)]).then((async([content,stats])=>{const{release_version,release_date,package_data}=await release_info();const release_newer=release_date.getTime()>stats.mtime.getTime();const environemnt=kh_js.isDevelopement?"developement":"";let code=kh_js.isString(content)?content:Buffer.isBuffer(content)?content.toString():content.toString();let counter=0;if("text/html"==content_type){const $appName=appName.toLowerCase().endsWith("app")?appName.slice(0,-3):appName;code=code.replace(/\$\{VERSION\}/g,(x=>(++counter,release_version)));code=code.replace(/\$\{ENVIRONMENT\}/g,(x=>(++counter,environemnt)));code=code.replace(/\$\{DATE\}/g,(x=>(++counter,release_date.toISODateString())));code=code.replace(/\$\{APPNAME\}/g,(x=>(++counter,appName.toUpperCase())));code=code.replace(/\$\{appname\}/g,(x=>(++counter,appName.toLowerCase())));code=code.replace(/\$\{AppName\}/g,(x=>(++counter,appName)));code=code.replace(/\$\{app_name\}/g,(x=>(++counter,appName.toLowerCase().replace(/\-/g,"_"))));code=code.replace(/\$\{\$APPNAME\}/g,(x=>(++counter,$appName.toUpperCase())));code=code.replace(/\$\{\$appname\}/g,(x=>(++counter,$appName.toLowerCase())));code=code.replace(/\$\{DESCRIPTION\}/g,(x=>(++counter,package_data?.description??"website")));code=code.replace(/\$\{THREEV\}/g,(x=>"@0.150.1"))}return{code,stats,last_modified:release_newer&&0<counter?release_date:stats.mtime,modified:0<counter}})).then((async({code,stats,last_modified,modified})=>{res.contentType(content_type);res.writeHead(200,kh_js.removeEmpty({"Last-Modified":last_modified?.toUTCString(),"Content-Length":modified?Buffer.byteLength(code,"utf8"):stats?.size}));res.write(code);res.end();return code}))}})).catch((async error=>{res.status(error.status||404);throw error}))}kh_global.LoadedScripts.get(mf).resolve(ms);