const kh_global=Function("return globalThis;")()||Function("return this;")()||Function("return self;")();const as_module=undefined==this;const asWorker="undefined"===typeof window&&"undefined"===typeof process&&self;const cf="kh_server";const mf="common_manage_headers_esm";kh_global.kh??={};kh_global.kh.context??="undefined"!==typeof window?kh_global.parent==kh_global?"window":"iframe":"undefined"!==typeof process?"node.js":"undefined"!==typeof self?self.name??"worker":"unknown";kh_global.kh.storage??={};const cs=kh_global.kh.storage[cf]??={cf,ms:new Set};const ms=kh_global.kh.storage[mf]??={mf,cs};cs.ms.add(ms);import*as mergePatch from"json8-merge-patch";import mime from"mime";import on_headers from"on-headers";import*as kh_js_e from"/contrib/jsm/kh_earlybird.js";import*as kh_js_c from"/contrib/jsm/kh_classes.js";const kh_js=Object.assign({...kh_js_e},{...kh_js_c});const name=MF`${mf}`;const print_level=undefined;import{Logger}from"/contrib/jsm/kh_log.js";const kh_log=new Logger(print_level,(()=>name));import{getSubRoute}from"/common/router_sub_route.mjs";export function manageHeaders(options={}){options=mergePatch.apply(cs.server_options,options);const ONE_MINUTE=60,ONE_HOUR=ONE_MINUTE*60,ONE_DAY=ONE_HOUR*24,ONE_WEEK=ONE_HOUR*7,ONE_MONTH=ONE_DAY*30,ONE_YEAR=ONE_DAY*365,RE_MIME_IMAGE=/^image/,RE_MIME_FONT=/^(?:application\/(?:font-woff|x-font-ttf|vnd\.ms-fontobject)|font\/opentype)$/,RE_MIME_DATA=/^(?:text\/(?:cache-manifest|html|xml)|application\/(?:(?:rdf\+)?xml|json|manifest\+json))/,RE_MIME_FEED=/^application\/(?:rss|atom)\+xml$/,RE_MIME_FAVICON=/^image\/x-icon$/,RE_MIME_MEDIA=/(image|video|audio|text\/x-component|application\/(?:font-woff|x-font-ttf|vnd\.ms-fontobject)|font\/opentype)/,RE_MIME_CSSJS=/^(?:text\/(?:css|x-component)|application\/javascript)/,RE_WWW=/^www\./,RE_MSIE=/MSIE/,RE_HIDDEN=/(^|\/)\./,RE_SRCBAK=/\.(?:bak|config|sql|fla|psd|ini|log|sh|inc|swp|dist)|~/;return function headersLayer(req,res,next){let pathname=req.path||"/";req.baseUrl=req.url;req.originalUrl=req.url=req.url.replace(/^(.+)\.((?:(?:0|[1-9]\d*)\.(?:0|[1-9]\d*)\.(?:0|[1-9]\d*)(?:-(?:(?:0|[1-9]\d*|\d*[a-zA-Z-][0-9a-zA-Z-]*)(?:\.(?:0|[1-9]\d*|\d*[a-zA-Z-][0-9a-zA-Z-]*))*))?(?:\+(?:[0-9a-zA-Z-]+(?:\.[0-9a-zA-Z-]+)*))?)|(?:\d{4}\.\d{1,2}\.\d{1,2}))\.(js|mjs|css|png|jpg|gif|json|html|htm)(\?.*)?$/,"$1.$3$4");req.originalUrl=req.url=req.url.replaceAll(/[\/\\]((?:(?:0|[1-9]\d*)\.(?:0|[1-9]\d*)\.(?:0|[1-9]\d*)(?:-(?:(?:0|[1-9]\d*|\d*[a-zA-Z-][0-9a-zA-Z-]*)(?:\.(?:0|[1-9]\d*|\d*[a-zA-Z-][0-9a-zA-Z-]*))*))?(?:\+(?:[0-9a-zA-Z-]+(?:\.[0-9a-zA-Z-]+)*))?))/g,"");const sub_route=req.sub_route??getSubRoute(req);on_headers(res,(()=>{const headers=mergePatch.apply(options.response?.headers||{},(cs.server_options.sr?.get(sub_route)??cs.server_options[sub_route])?.response?.headers||{});let content_type=res.getHeader("Content-Type");const mime_extension=(mime.getExtension||mime.extension).bind(mime);if(!content_type||!mime_extension(content_type.split(";")[0])){content_type=""}if(options.cors)res.setHeader("Access-Control-Allow-Origin",headers["Access-Control-Allow-Origin"]??"*");delete headers["Access-Control-Allow-Origin"];if(RE_MIME_IMAGE.test(content_type))res.setHeader("Access-Control-Allow-Origin","*");if(RE_MIME_FONT.test(content_type)||"/font.css"==pathname){res.setHeader("Access-Control-Allow-Origin","*")}if(kh_js.isEmpty(res.getHeader("Cache-Control"))){let cc;if(!content_type||RE_MIME_DATA.test(content_type)){cc="public,max-age=5"}else if(RE_MIME_FEED.test(content_type)){cc="public,max-age="+ONE_HOUR}else if(RE_MIME_FAVICON.test(content_type)){cc="public,max-age="+ONE_WEEK}else if(RE_MIME_MEDIA.test(content_type)){cc="public,max-age="+ONE_MONTH}else if(RE_MIME_CSSJS.test(content_type)){cc="public,max-age="+ONE_YEAR}else{cc="public,max-age="+ONE_MONTH}cc=`${kh_js.isEmpty(cc)?"":`${cc},`}no-transform`;res.setHeader("Cache-Control",cc)}res.removeHeader("ETag");if(process.version.match(/v(\d+)\./)[1]<19&&kh_js.isEmpty(res.getHeader("Connection"))){res.setHeader("Connection","keep-alive")}else delete headers["Connection"];Object.entries(headers).forEach((([k,v])=>res.setHeader(k,v)))}));next()}}kh_global.LoadedScripts.get(mf).resolve(ms);